<ion-content class="ion-no-padding">
  
  <!-- Header móvil (solo visible en móvil) -->
  <div class="header-movil">
    <button class="btn-menu-hamburguesa" (click)="toggleMenuMovil()">
      <ion-icon name="menu-outline"></ion-icon>
    </button>
    <h1>SouFit</h1>
    <button class="btn-crear-post-movil" (click)="abrirModalCrearPost()">
      <ion-icon name="add-outline"></ion-icon>
    </button>
  </div>
  
  <!-- Menú móvil desplegable -->
  <div class="menu-movil-overlay" [class.activo]="menuMovilAbierto" (click)="cerrarMenuMovil()"></div>
  <div class="menu-movil" [class.activo]="menuMovilAbierto">
    <div class="menu-movil-header">
      <h2>SouFit</h2>
      <button class="btn-cerrar-menu" (click)="cerrarMenuMovil()">
        <ion-icon name="close-outline"></ion-icon>
      </button>
    </div>
    <div class="menu-movil-items">
      <div class="menu-item activo" (click)="navegarYcerrarMenu('/home')">
        <ion-icon name="home-outline"></ion-icon>
        <span>Inicio</span>
      </div>
      <div class="menu-item" (click)="navegarYcerrarMenu('/buscar')">
        <ion-icon name="search-outline"></ion-icon>
        <span>Buscar</span>
      </div>
      <div class="menu-item" (click)="navegarYcerrarMenu('/rutinas')">
        <ion-icon name="barbell-outline"></ion-icon>
        <span>Rutinas</span>
      </div>
      <div class="menu-item" (click)="navegarYcerrarMenu('/mensajeria')">
        <ion-icon name="chatbubbles-outline"></ion-icon>
        <span>Mensajería</span>
        <span class="badge-notificacion" *ngIf="contadorMensajesNoLeidos > 0">{{ contadorMensajesNoLeidos }}</span>
      </div>
      <div class="menu-item" (click)="navegarYcerrarMenu('/perfil')">
        <ion-icon name="person-outline"></ion-icon>
        <span>Perfil</span>
      </div>
    </div>
  </div>
  
  <ion-grid style="height: 100vh;">
    <ion-row style="height: 100%;">
      
    
      <ion-col size="auto" class="menu-lateral">
        
        <div class="logo">
          <img src="assets/icon/SouFitLogo.png" alt="Logo" style="width: 32px; height: 32px;">
        </div>
   
        <div class="boton-menu activo">
          <ion-icon name="home-outline"></ion-icon>
          <p>Inicio</p>
        </div>

        <div class="boton-menu" (click)="buscar()">
          <ion-icon name="search-outline"></ion-icon>
          <p>Buscar</p>
        </div>

        <div class="boton-menu" (click)="rutinas()">
          <ion-icon name="barbell-outline"></ion-icon>
          <p>Rutinas</p>
        </div>
                      
        <div class="boton-menu" (click)="mensajeria()">
          <ion-icon name="chatbubbles-outline"></ion-icon>
          <p>Mensajeria</p>
        </div>


        <div class="boton-menu" (click)="perfil()">
          <ion-icon name="person-outline"></ion-icon>
          <p>Perfil</p>
        </div>

      </ion-col>

      <ion-col class="feed-centro">
        
        <div class="titulo-feed">
          <h1>SouFit</h1>
          <div class="feed-actions">
            <!-- Toggle tema -->
            <button class="btn-toggle-theme" (click)="toggleTheme()" [attr.aria-label]="'Cambiar tema'">
              <ion-icon [name]="themeService.getTheme() === 'dark' ? 'moon' : 'sunny'"></ion-icon>
            </button>
            <button class="btn-crear-post" (click)="abrirModalCrearPost()">
              <ion-icon name="add-outline"></ion-icon>
              Crear Post
            </button>
          </div>
        </div>
        
        <!-- Filtros -->
        <div class="filtros-feed">
          <div class="filtro-grupo">
            <label>Tipo:</label>
            <select [(ngModel)]="filtroTipo" (change)="aplicarFiltros()" class="filtro-select">
              <option value="todos">Todos</option>
              <option value="texto">Texto</option>
              <option value="ejercicio">Ejercicio</option>
              <option value="rutina">Rutina</option>
              <option value="logro">Logro</option>
            </select>
          </div>
          <div class="filtro-grupo">
            <label>Orden:</label>
            <select [(ngModel)]="filtroOrden" (change)="aplicarFiltros()" class="filtro-select">
              <option value="recientes">Recientes</option>
              <option value="populares">Populares</option>
            </select>
          </div>
        </div>

        <div class="posts-contenedor" #postsContainer (scroll)="onScroll($event)">
          <!-- Loading inicial -->
          <div *ngIf="cargando && posts.length === 0" class="loading-container">
            <ion-spinner></ion-spinner>
            <p>Cargando feed...</p>
          </div>
          
          <!-- Skeleton loaders -->
          <div *ngIf="cargando && posts.length === 0" class="skeleton-container">
            <div *ngFor="let i of [1,2,3]" class="skeleton-post">
              <div class="skeleton-header">
                <div class="skeleton-avatar"></div>
                <div class="skeleton-text">
                  <div class="skeleton-line short"></div>
                  <div class="skeleton-line shorter"></div>
                </div>
              </div>
              <div class="skeleton-content">
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line medium"></div>
              </div>
            </div>
          </div>

          <!-- Posts -->
          <div *ngIf="!cargando && posts.length === 0" class="sin-posts">
            <p>No hay publicaciones aún. ¡Sé el primero en publicar!</p>
          </div>

          <div *ngFor="let post of posts" class="post">
            <div class="post-header">
              <div class="post-usuario" (click)="verPerfil(post.autor_id || post.id_usuario)">
                <ion-avatar>
                  <img [src]="getImageUrl(post.autor_avatar)" [alt]="post.autor_username" loading="lazy" (error)="handleImageError($event)">
                </ion-avatar>
                <div>
                  <h3>{{ post.autor_nombre || post.autor_username }}</h3>
                  <p>{{ post.fecha_publicacion ? formatearFecha(post.fecha_publicacion) : 'Ahora' }}</p>
                </div>
              </div>
              <button 
                *ngIf="(post.autor_id || post.id_usuario) !== usuarioActual?.id && !post.sigo_autor" 
                class="btn-seguir-post"
                (click)="seguirUsuarioDesdePost(post.autor_id || post.id_usuario, post)">
                Seguir
              </button>
              <button 
                *ngIf="(post.autor_id || post.id_usuario) !== usuarioActual?.id && post.sigo_autor" 
                class="btn-siguiendo-post"
                (click)="dejarDeSeguirDesdePost(post.autor_id || post.id_usuario, post)">
                Siguiendo
              </button>
            </div>
            
            <div class="post-contenido">
              <!-- Botón eliminar para posts propios -->
              <button 
                *ngIf="(post.autor_id || post.id_usuario) === usuarioActual?.id && post.id_post"
                class="btn-eliminar-post"
                (click)="eliminarPost(post.id_post)"
                aria-label="Eliminar post">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
              
              <p *ngIf="post.contenido" class="post-texto">{{ post.contenido }}</p>
              <div *ngIf="post.url_media" class="post-media">
                <img [src]="getImageUrl(post.url_media)" alt="Media del post" loading="lazy" (error)="handleImageError($event)">
              </div>
              <div *ngIf="post.nombre_ejercicio" class="post-ejercicio">
                <ion-chip color="primary">
                  <ion-icon name="barbell-outline"></ion-icon>
                  <ion-label>{{ post.nombre_ejercicio }}</ion-label>
                </ion-chip>
              </div>
              <div *ngIf="post.nombre_rutina" class="post-rutina">
                <ion-chip color="secondary">
                  <ion-icon name="fitness-outline"></ion-icon>
                  <ion-label>{{ post.nombre_rutina }}</ion-label>
                </ion-chip>
              </div>
            </div>
            
            <div class="post-acciones">
              <button class="btn-accion" (click)="reaccionarPost(post)" [class.activo]="post.me_gusta">
                <ion-icon [name]="post.me_gusta ? 'heart' : 'heart-outline'"></ion-icon>
                <span>{{ toNumber(post.total_likes) }}</span>
              </button>
              <button class="btn-accion" (click)="toggleComentarios(post.id_post!)">
                <ion-icon name="chatbubble-outline"></ion-icon>
                <span>{{ toNumber(post.total_comentarios) }}</span>
              </button>
              <button class="btn-accion" (click)="compartirPost(post)">
                <ion-icon name="share-outline"></ion-icon>
                <span>{{ toNumber(post.total_compartidos) }}</span>
              </button>
            </div>

            <!-- Comentarios -->
            <div *ngIf="mostrandoComentarios[post.id_post!]" class="comentarios-container">
              <div *ngFor="let comentario of comentarios[post.id_post!]" class="comentario">
                <ion-avatar class="avatar-comentario">
                  <img [src]="getImageUrl(comentario.autor_avatar)" [alt]="comentario.autor_username" (error)="handleImageError($event)">
                </ion-avatar>
                <div class="comentario-contenido">
                  <strong>{{ comentario.autor_nombre || comentario.autor_username }}</strong>
                  <p>{{ comentario.contenido }}</p>
                </div>
              </div>
              
              <div class="nuevo-comentario">
                <ion-avatar class="avatar-comentario">
                  <img [src]="getImageUrl(usuarioActual?.avatar)" [alt]="usuarioActual?.username" (error)="handleImageError($event)">
                </ion-avatar>
                <input 
                  type="text" 
                  placeholder="Escribe un comentario..."
                  [(ngModel)]="nuevoComentario[post.id_post!]"
                  (keydown.enter)="comentarPost(post.id_post!)"
                  class="input-comentario">
                <button class="btn-enviar-comentario" (click)="comentarPost(post.id_post!)" [disabled]="!nuevoComentario[post.id_post!]?.trim()">
                  <ion-icon name="send-outline"></ion-icon>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Loading más posts -->
          <div *ngIf="cargandoMas" class="loading-mas-container">
            <ion-spinner></ion-spinner>
            <p>Cargando más posts...</p>
          </div>
          
          <!-- No hay más posts -->
          <div *ngIf="!hayMasPosts && posts.length > 0" class="no-mas-posts">
            <p>No hay más publicaciones</p>
          </div>
        </div>
      </ion-col>

      
      <ion-col size="3" class="ejercicios-lateral">
        
        <h2>Ejercicios Recomendados</h2>
        
      
          <div *ngFor="let ejercicio of ejercicios" class="ejercicio" (click)="verEjercicio(ejercicio.id_ejercicio!)">
          <div class="ejercicio-icono">
            <ion-icon name="barbell-outline"></ion-icon>
          </div>
          <div class="ejercicio-info">
            <h3>{{ ejercicio.nombre_ejercicio }}</h3>
            <p>{{ ejercicio.duracion_minutos || 15 }} min • {{ ejercicio.grupo_muscular || 'General' }}</p>
          </div>
          <button class="ejercicio-boton" (click)="verEjercicio(ejercicio.id_ejercicio!); $event.stopPropagation()">Ver</button>
        </div>

        <div *ngIf="ejercicios.length === 0" class="sin-ejercicios">
          <p>No hay ejercicios recomendados</p>
        </div>

      </ion-col>

    </ion-row>
  </ion-grid>

  <!-- Modal Crear Post -->
  <ion-modal [isOpen]="mostrarModalCrearPost" (didDismiss)="cerrarModalCrearPost()">
    <ion-header>
      <ion-toolbar>
        <ion-title>Crear Publicación</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalCrearPost()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
        <div class="modal-body">
          <div class="tipo-post-selector">
            <button 
              class="btn-tipo-post" 
              [class.activo]="nuevoPost.tipo_post === 'texto'"
              (click)="nuevoPost.tipo_post = 'texto'">
              Texto
            </button>
            <button 
              class="btn-tipo-post" 
              [class.activo]="nuevoPost.tipo_post === 'logro'"
              (click)="nuevoPost.tipo_post = 'logro'">
              Logro
            </button>
            <button 
              class="btn-tipo-post" 
              [class.activo]="nuevoPost.tipo_post === 'ejercicio'"
              (click)="nuevoPost.tipo_post = 'ejercicio'">
              Ejercicio
            </button>
            <button 
              class="btn-tipo-post" 
              [class.activo]="nuevoPost.tipo_post === 'rutina'"
              (click)="nuevoPost.tipo_post = 'rutina'">
              Rutina
            </button>
          </div>

          <ion-textarea
            [(ngModel)]="nuevoPost.contenido"
            placeholder="¿Qué quieres compartir?"
            rows="6"
            class="input-post">
          </ion-textarea>

          <!-- Opción 1: Subir archivo -->
          <div class="upload-section">
            <label class="upload-label">
              <input 
                type="file" 
                accept="image/*" 
                (change)="onFileSelected($event)"
                style="display: none;"
                #fileInput>
              <ion-button fill="outline" expand="block" (click)="fileInput.click()">
                <ion-icon name="image-outline" slot="start"></ion-icon>
                Seleccionar Imagen
              </ion-button>
            </label>
          </div>

          <!-- Preview de imagen subida -->
          <div *ngIf="previewImagen" class="preview-media">
            <img [src]="previewImagen" alt="Preview" (error)="handleImageError($event)">
            <button class="btn-remover-media" (click)="removerImagen()">
              <ion-icon name="close-outline"></ion-icon>
            </button>
          </div>

          <!-- Opción 2: URL (alternativa) -->
          <div class="divider">
            <span>O</span>
          </div>

          <ion-input
            [(ngModel)]="nuevoPost.url_media"
            placeholder="URL de imagen (opcional)"
            type="url"
            class="input-url"
            [disabled]="!!archivoSeleccionado">
          </ion-input>

          <div *ngIf="nuevoPost.url_media && !archivoSeleccionado" class="preview-media">
            <img [src]="getImageUrl(nuevoPost.url_media)" alt="Preview" (error)="handleImageError($event)">
            <button class="btn-remover-media" (click)="nuevoPost.url_media = ''">
              <ion-icon name="close-outline"></ion-icon>
            </button>
          </div>

          <ion-button expand="block" (click)="crearPost()" [disabled]="!nuevoPost.contenido.trim()">
            Publicar
          </ion-button>
        </div>
      </ion-content>
    </ion-modal>
</ion-content>