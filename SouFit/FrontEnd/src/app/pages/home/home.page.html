<ion-content class="ion-no-padding">
  
  <!-- Header m√≥vil (solo visible en m√≥vil) -->
  <div class="header-movil">
    <button class="btn-menu-hamburguesa" (click)="toggleMenuMovil()">
      <ion-icon name="menu-outline"></ion-icon>
    </button>
    <h1>SouFit</h1>
    <button class="btn-crear-post-movil" (click)="abrirModalCrearPost()">
      <ion-icon name="add-outline"></ion-icon>
    </button>
  </div>
  
  <!-- Men√∫ m√≥vil desplegable -->
  <div class="menu-movil-overlay" [class.activo]="menuMovilAbierto" (click)="cerrarMenuMovil()"></div>
  <div class="menu-movil" [class.activo]="menuMovilAbierto">
    <div class="menu-movil-header">
      <h2>SouFit</h2>
      <button class="btn-cerrar-menu" (click)="cerrarMenuMovil()">
        <ion-icon name="close-outline"></ion-icon>
      </button>
    </div>
    <div class="menu-movil-items">
      <div class="menu-item activo" (click)="navegarYcerrarMenu('/home')">
        <ion-icon name="home-outline"></ion-icon>
        <span>Inicio</span>
      </div>
      <div class="menu-item" (click)="navegarYcerrarMenu('/buscar')">
        <ion-icon name="search-outline"></ion-icon>
        <span>Buscar</span>
      </div>
      <div class="menu-item" (click)="navegarYcerrarMenu('/rutinas')">
        <ion-icon name="barbell-outline"></ion-icon>
        <span>Rutinas</span>
      </div>
      <div class="menu-item" (click)="navegarYcerrarMenu('/mensajeria')">
        <ion-icon name="chatbubbles-outline"></ion-icon>
        <span>Mensajer√≠a</span>
        <span class="badge-notificacion" *ngIf="contadorMensajesNoLeidos > 0">{{ contadorMensajesNoLeidos }}</span>
      </div>
      <div class="menu-item" (click)="navegarYcerrarMenu('/perfil')">
        <ion-icon name="person-outline"></ion-icon>
        <span>Perfil</span>
      </div>
    </div>
  </div>
  
  <ion-grid style="height: 100vh;">
    <ion-row style="height: 100%;">
      
    
      <ion-col size="auto" class="menu-lateral">
        
        <div class="logo">
          <img src="assets/icon/SouFitLogo.png" alt="Logo" style="width: 32px; height: 32px;">
        </div>
   
        <div class="boton-menu activo">
          <ion-icon name="home-outline"></ion-icon>
          <p>Inicio</p>
        </div>

        <div class="boton-menu" (click)="buscar()">
          <ion-icon name="search-outline"></ion-icon>
          <p>Buscar</p>
        </div>

        <div class="boton-menu" (click)="rutinas()">
          <ion-icon name="barbell-outline"></ion-icon>
          <p>Rutinas</p>
        </div>
                      
        <div class="boton-menu" (click)="mensajeria()">
          <ion-icon name="chatbubbles-outline"></ion-icon>
          <p>Mensajeria</p>
        </div>


        <div class="boton-menu" (click)="perfil()">
          <ion-icon name="person-outline"></ion-icon>
          <p>Perfil</p>
        </div>

      </ion-col>

      <ion-col class="feed-centro">
        
        <div class="titulo-feed">
          <h1>SouFit</h1>
          <div class="feed-actions">
            <!-- Toggle tema -->
            <button class="btn-toggle-theme" (click)="toggleTheme()" [attr.aria-label]="'Cambiar tema'">
              <ion-icon [name]="themeService.getTheme() === 'dark' ? 'moon' : 'sunny'"></ion-icon>
            </button>
            <button class="btn-crear-post" (click)="abrirModalCrearPost()">
              <ion-icon name="add-outline"></ion-icon>
              Crear Post
            </button>
          </div>
        </div>
        
        <!-- Filtros -->
        <div class="filtros-feed-modernos">
          <div class="filtros-container">
            <div class="filtro-grupo-moderno">
              <label>Tipo:</label>
              <select [(ngModel)]="filtroTipo" (change)="aplicarFiltros()" class="filtro-select-moderno">
                <option value="todos">üìã Todos</option>
                <option value="texto">üìù Texto</option>
                <option value="ejercicio">üí™ Ejercicio</option>
                <option value="rutina">üèãÔ∏è Rutina</option>
                <option value="logro">üèÜ Logro</option>
              </select>
            </div>
            <div class="filtro-grupo-moderno">
              <label>Orden:</label>
              <select [(ngModel)]="filtroOrden" (change)="aplicarFiltros()" class="filtro-select-moderno">
                <option value="recientes">üïê Recientes</option>
                <option value="populares">üî• Populares</option>
              </select>
            </div>
            <button 
              *ngIf="filtroTipo !== 'todos' || filtroOrden !== 'recientes'"
              class="btn-limpiar-filtros"
              (click)="limpiarFiltros()"
              title="Limpiar filtros">
              <ion-icon name="close-outline"></ion-icon>
            </button>
          </div>
        </div>

        <div class="posts-contenedor" #postsContainer (scroll)="onScroll($event)">
          <!-- Loading inicial -->
          <div *ngIf="cargando && posts.length === 0" class="loading-container">
            <ion-spinner></ion-spinner>
            <p>Cargando feed...</p>
          </div>
          
          <!-- Skeleton loaders -->
          <div *ngIf="cargando && posts.length === 0" class="skeleton-container">
            <div *ngFor="let i of [1,2,3]" class="skeleton-post">
              <div class="skeleton-header">
                <div class="skeleton-avatar"></div>
                <div class="skeleton-text">
                  <div class="skeleton-line short"></div>
                  <div class="skeleton-line shorter"></div>
                </div>
              </div>
              <div class="skeleton-content">
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line medium"></div>
              </div>
            </div>
          </div>

          <!-- Posts -->
          <div *ngIf="!cargando && posts.length === 0" class="sin-posts">
            <p>No hay publicaciones a√∫n. ¬°S√© el primero en publicar!</p>
          </div>

          <div *ngFor="let post of posts" class="post">
            <div class="post-header">
              <div class="post-usuario" (click)="verPerfil(post.autor_id || post.id_usuario)">
                <ion-avatar>
                  <img [src]="getImageUrl(post.autor_avatar)" [alt]="post.autor_username" loading="lazy" (error)="handleImageError($event)">
                </ion-avatar>
                <div>
                  <h3>{{ post.autor_nombre || post.autor_username }}</h3>
                  <p>{{ post.fecha_publicacion ? formatearFecha(post.fecha_publicacion) : 'Ahora' }}</p>
                </div>
              </div>
              <button 
                *ngIf="(post.autor_id || post.id_usuario) !== usuarioActual?.id && !post.sigo_autor" 
                class="btn-seguir-post"
                (click)="seguirUsuarioDesdePost(post.autor_id || post.id_usuario, post)">
                Seguir
              </button>
              <button 
                *ngIf="(post.autor_id || post.id_usuario) !== usuarioActual?.id && post.sigo_autor" 
                class="btn-siguiendo-post"
                (click)="dejarDeSeguirDesdePost(post.autor_id || post.id_usuario, post)">
                Siguiendo
              </button>
            </div>
            
            <div class="post-contenido">
              <!-- Bot√≥n eliminar para posts propios -->
              <button 
                *ngIf="(post.autor_id || post.id_usuario) === usuarioActual?.id && post.id_post"
                class="btn-eliminar-post"
                (click)="eliminarPost(post.id_post)"
                aria-label="Eliminar post">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
              
              <p *ngIf="post.contenido" class="post-texto">{{ post.contenido }}</p>
              <div *ngIf="post.url_media" class="post-media">
                <img [src]="getImageUrl(post.url_media)" alt="Media del post" loading="lazy" (error)="handleImageError($event)">
              </div>
              <div *ngIf="post.nombre_ejercicio" class="post-ejercicio">
                <ion-chip color="primary">
                  <ion-icon name="barbell-outline"></ion-icon>
                  <ion-label>{{ post.nombre_ejercicio }}</ion-label>
                </ion-chip>
              </div>
              <div *ngIf="post.nombre_rutina" class="post-rutina">
                <ion-chip color="secondary">
                  <ion-icon name="fitness-outline"></ion-icon>
                  <ion-label>{{ post.nombre_rutina }}</ion-label>
                </ion-chip>
              </div>
            </div>
            
            <div class="post-acciones">
              <button class="accion-item" (click)="reaccionarPost(post)" [class.activo]="post.me_gusta">
                <ion-icon [name]="post.me_gusta ? 'heart' : 'heart-outline'"></ion-icon>
                <span>{{ toNumber(post.total_likes) }}</span>
              </button>
              <button class="accion-item" (click)="toggleComentarios(post.id_post!)">
                <ion-icon name="chatbubble-outline"></ion-icon>
                <span>{{ toNumber(post.total_comentarios) }}</span>
              </button>
              <button class="accion-item" (click)="compartirPost(post)">
                <ion-icon name="share-outline"></ion-icon>
                <span>{{ toNumber(post.total_compartidos) }}</span>
              </button>
            </div>

            <!-- Comentarios -->
            <div *ngIf="mostrandoComentarios[post.id_post!]" class="comentarios-section">
              <div class="comentarios-header">
                <h4>Comentarios ({{ comentarios[post.id_post!]?.length || 0 }})</h4>
                <button (click)="toggleComentarios(post.id_post!)">Cerrar</button>
              </div>
              
              <div *ngFor="let comentario of comentarios[post.id_post!]" class="comentario-item">
                <ion-avatar>
                  <img [src]="getImageUrl(comentario.autor_avatar)" [alt]="comentario.autor_username" (error)="handleImageError($event)">
                </ion-avatar>
                <div class="comentario-contenido">
                  <div class="comentario-autor">{{ comentario.autor_nombre || comentario.autor_username }}</div>
                  <p class="comentario-texto">{{ comentario.contenido }}</p>
                  <div class="comentario-fecha">{{ comentario.fecha_comentario ? formatearFecha(comentario.fecha_comentario) : '' }}</div>
                </div>
              </div>
              
              <div class="input-comentario">
                <ion-avatar>
                  <img [src]="getImageUrl(usuarioActual?.avatar)" [alt]="usuarioActual?.username" (error)="handleImageError($event)">
                </ion-avatar>
                <ion-textarea
                  [(ngModel)]="nuevoComentario[post.id_post!]"
                  placeholder="Escribe un comentario..."
                  rows="1"
                  [autoGrow]="true">
                </ion-textarea>
                <ion-button (click)="comentarPost(post.id_post!)" [disabled]="!nuevoComentario[post.id_post!]?.trim()">
                  <ion-icon name="send-outline" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>
          
          <!-- Loading m√°s posts -->
          <div *ngIf="cargandoMas" class="loading-mas-container">
            <ion-spinner></ion-spinner>
            <p>Cargando m√°s posts...</p>
          </div>
          
          <!-- No hay m√°s posts -->
          <div *ngIf="!hayMasPosts && posts.length > 0" class="no-mas-posts">
            <p>No hay m√°s publicaciones</p>
          </div>
        </div>
      </ion-col>

      
      <ion-col size="3" class="ejercicios-lateral">
        
        <h2>Ejercicios Recomendados</h2>
        
      
          <div *ngFor="let ejercicio of ejercicios" class="ejercicio" (click)="verEjercicio(ejercicio.id_ejercicio!)">
          <div class="ejercicio-icono">
            <ion-icon name="barbell-outline"></ion-icon>
          </div>
          <div class="ejercicio-info">
            <h3>{{ ejercicio.nombre_ejercicio }}</h3>
            <p>{{ ejercicio.duracion_minutos || 15 }} min ‚Ä¢ {{ ejercicio.grupo_muscular || 'General' }}</p>
          </div>
          <button class="ejercicio-boton" (click)="verEjercicio(ejercicio.id_ejercicio!); $event.stopPropagation()">Ver</button>
        </div>

        <div *ngIf="ejercicios.length === 0" class="sin-ejercicios">
          <p>No hay ejercicios recomendados</p>
        </div>

      </ion-col>

    </ion-row>
  </ion-grid>

  <!-- Modal Crear Post -->
  <ion-modal [isOpen]="mostrarModalCrearPost" (didDismiss)="cerrarModalCrearPost()">
    <ion-header>
      <ion-toolbar>
        <ion-title>Crear Publicaci√≥n</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalCrearPost()" fill="clear">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <div class="modal-crear-post">
        <!-- Selector de tipo de post -->
        <div class="tipo-post-selector-moderno">
          <button 
            class="btn-tipo-post-moderno" 
            [class.activo]="nuevoPost.tipo_post === 'texto'"
            (click)="nuevoPost.tipo_post = 'texto'; onTipoPostChange()">
            <ion-icon name="document-text-outline"></ion-icon>
            <span>Texto</span>
          </button>
          <button 
            class="btn-tipo-post-moderno" 
            [class.activo]="nuevoPost.tipo_post === 'logro'"
            (click)="nuevoPost.tipo_post = 'logro'; onTipoPostChange()">
            <ion-icon name="trophy-outline"></ion-icon>
            <span>Logro</span>
          </button>
          <button 
            class="btn-tipo-post-moderno" 
            [class.activo]="nuevoPost.tipo_post === 'ejercicio'"
            (click)="nuevoPost.tipo_post = 'ejercicio'; onTipoPostChange()">
            <ion-icon name="barbell-outline"></ion-icon>
            <span>Ejercicio</span>
          </button>
          <button 
            class="btn-tipo-post-moderno" 
            [class.activo]="nuevoPost.tipo_post === 'rutina'"
            (click)="nuevoPost.tipo_post = 'rutina'; onTipoPostChange()">
            <ion-icon name="fitness-outline"></ion-icon>
            <span>Rutina</span>
          </button>
        </div>

        <!-- Selector de ejercicio (si tipo es ejercicio) -->
        <div *ngIf="nuevoPost.tipo_post === 'ejercicio'" class="selector-ejercicio-rutina">
          <label>Selecciona un ejercicio:</label>
          <ion-item class="select-item-moderno">
            <ion-select 
              [(ngModel)]="ejercicioSeleccionado" 
              placeholder="Buscar ejercicio..."
              interface="popover"
              class="select-moderno-post">
              <ion-select-option *ngFor="let ejercicio of ejerciciosDisponibles" [value]="ejercicio">
                {{ ejercicio.nombre_ejercicio }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <div *ngIf="ejercicioSeleccionado" class="item-seleccionado">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
            <span>{{ ejercicioSeleccionado.nombre_ejercicio }}</span>
          </div>
        </div>

        <!-- Selector de rutina (si tipo es rutina) -->
        <div *ngIf="nuevoPost.tipo_post === 'rutina'" class="selector-ejercicio-rutina">
          <label>Selecciona una rutina:</label>
          <ion-item class="select-item-moderno">
            <ion-select 
              [(ngModel)]="rutinaSeleccionada" 
              placeholder="Buscar rutina..."
              interface="popover"
              class="select-moderno-post">
              <ion-select-option *ngFor="let rutina of rutinasDisponibles" [value]="rutina">
                {{ rutina.nombre_rutina }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <div *ngIf="rutinaSeleccionada" class="item-seleccionado">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
            <span>{{ rutinaSeleccionada.nombre_rutina }}</span>
          </div>
        </div>

        <!-- Textarea para contenido -->
        <div class="form-group-moderno">
          <ion-textarea
            [(ngModel)]="nuevoPost.contenido"
            [placeholder]="nuevoPost.tipo_post === 'logro' ? 'Comparte tu logro...' : nuevoPost.tipo_post === 'ejercicio' ? 'Comparte tu experiencia con este ejercicio...' : nuevoPost.tipo_post === 'rutina' ? 'Comparte tu experiencia con esta rutina...' : '¬øQu√© quieres compartir?'"
            rows="6"
            class="textarea-moderno-post"
            [autoGrow]="true"
            maxlength="1000">
          </ion-textarea>
          <div class="contador-caracteres-moderno" [class.warning]="nuevoPost.contenido.length > 900">
            {{ nuevoPost.contenido.length }} / 1000
          </div>
        </div>

        <!-- Secci√≥n de imagen -->
        <div class="imagen-section-moderno">
          <label class="upload-label-moderno">
            <input 
              type="file" 
              accept="image/*" 
              (change)="onFileSelected($event)"
              style="display: none;"
              #fileInput>
            <button type="button" class="btn-subir-imagen" (click)="fileInput.click()">
              <ion-icon name="image-outline"></ion-icon>
              <span>Agregar Imagen</span>
            </button>
          </label>

          <!-- Preview de imagen -->
          <div *ngIf="previewImagen" class="preview-imagen-moderno">
            <div class="preview-imagen-wrapper">
              <img [src]="previewImagen" alt="Preview" (error)="handleImageError($event)">
              <button class="btn-remover-imagen" (click)="removerImagen()" type="button">
                <ion-icon name="close-outline"></ion-icon>
              </button>
            </div>
          </div>

          <!-- URL alternativa (solo si no hay archivo) -->
          <div *ngIf="!archivoSeleccionado" class="url-alternativa">
            <div class="divider-moderno">
              <span>O</span>
            </div>
            <ion-input
              [(ngModel)]="nuevoPost.url_media"
              placeholder="URL de imagen (opcional)"
              type="url"
              class="input-url-moderno">
            </ion-input>
            <div *ngIf="nuevoPost.url_media && !archivoSeleccionado" class="preview-imagen-moderno">
              <div class="preview-imagen-wrapper">
                <img [src]="getImageUrl(nuevoPost.url_media)" alt="Preview" (error)="handleImageError($event)">
                <button class="btn-remover-imagen" (click)="nuevoPost.url_media = ''" type="button">
                  <ion-icon name="close-outline"></ion-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Bot√≥n de publicar -->
        <div class="acciones-modal">
          <ion-button 
            expand="block" 
            (click)="crearPost()" 
            [disabled]="creandoPost || !nuevoPost.contenido.trim() || nuevoPost.contenido.length > 1000 || nuevoPost.contenido.length < 3 || (nuevoPost.tipo_post === 'ejercicio' && !ejercicioSeleccionado) || (nuevoPost.tipo_post === 'rutina' && !rutinaSeleccionada)"
            class="btn-publicar-moderno">
            <ion-spinner *ngIf="creandoPost" name="crescent" slot="start"></ion-spinner>
            <ion-icon *ngIf="!creandoPost" name="send-outline" slot="start"></ion-icon>
            {{ creandoPost ? 'Publicando...' : 'Publicar' }}
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ion-modal>
</ion-content>