<ion-content class="ion-no-padding">
  
  <!-- Header móvil -->
  <div class="header-movil">
    <button class="btn-menu-hamburguesa" (click)="volverHome()">
      <ion-icon name="arrow-back-outline"></ion-icon>
    </button>
    <h1>Buscar</h1>
    <div style="width: 40px;"></div> <!-- Spacer para centrar -->
  </div>
  
  <ion-grid style="height: 100vh;">
    <ion-row style="height: 100%;">
      
      <ion-col size="auto" class="menu-lateral">
        <div class="logo">
          <img src="assets/icon/SouFitLogo.png" alt="Logo" style="width: 32px; height: 32px;">
        </div>
   
        <div class="boton-menu" (click)="volverHome()">
          <ion-icon name="home-outline"></ion-icon>
          <p>Inicio</p>
        </div>

        <div class="boton-menu activo">
          <ion-icon name="search-outline"></ion-icon>
          <p>Buscar</p>
        </div>

        <div class="boton-menu" (click)="rutinas()">
          <ion-icon name="barbell-outline"></ion-icon>
          <p>Rutinas</p>
        </div>
                      
        <div class="boton-menu" (click)="mensajeria()">
          <ion-icon name="chatbubbles-outline"></ion-icon>
          <p>Mensajeria</p>
        </div>

        <div class="boton-menu" (click)="perfil()">
          <ion-icon name="person-outline"></ion-icon>
          <p>Perfil</p>
        </div>
      </ion-col>

      <ion-col class="buscar-centro">
        <div class="titulo-buscar">
          <h1>Buscar</h1>
        </div>

        <div class="buscar-contenedor">
          <!-- Selector de tipo de búsqueda -->
          <div class="selector-tipo">
            <button 
              class="btn-tipo" 
              [class.activo]="tipoBusqueda === 'usuarios'"
              (click)="cambiarTipoBusqueda('usuarios')">
              <ion-icon name="person-outline"></ion-icon>
              Usuarios
            </button>
            <button 
              class="btn-tipo" 
              [class.activo]="tipoBusqueda === 'ejercicios'"
              (click)="cambiarTipoBusqueda('ejercicios')">
              <ion-icon name="barbell-outline"></ion-icon>
              Ejercicios
            </button>
          </div>

          <!-- Campo de búsqueda mejorado -->
          <div class="campo-busqueda-moderno">
            <div class="input-busqueda-wrapper">
              <ion-icon name="search-outline" class="icono-busqueda-input"></ion-icon>
              <ion-input
                [(ngModel)]="terminoBusqueda"
                [placeholder]="'Buscar ' + (tipoBusqueda === 'usuarios' ? 'usuarios' : 'ejercicios') + '...'"
                (ionInput)="onSearchInput($event)"
                (keydown.enter)="buscarDirecto(terminoBusqueda)"
                class="input-busqueda-mejorado">
              </ion-input>
              <button 
                *ngIf="terminoBusqueda"
                class="btn-limpiar-busqueda"
                (click)="terminoBusqueda = ''; limpiarResultados()">
                <ion-icon name="close-outline"></ion-icon>
              </button>
            </div>
            <ion-button 
              (click)="buscarDirecto(terminoBusqueda)" 
              [disabled]="terminoBusqueda.length < 2 || cargando"
              class="btn-buscar-mejorado">
              <ion-spinner *ngIf="cargando" name="crescent"></ion-spinner>
              <ion-icon *ngIf="!cargando" name="search-outline"></ion-icon>
            </ion-button>
          </div>
          
          <!-- Historial de búsquedas -->
          <div *ngIf="mostrarHistorial && historialBusquedas.length > 0 && terminoBusqueda.length < 2" class="historial-busquedas">
            <div class="historial-header">
              <h4>Búsquedas recientes</h4>
              <button class="btn-limpiar-historial" (click)="limpiarHistorialCompleto()">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>
            <div class="historial-items">
              <div 
                *ngFor="let termino of historialBusquedas" 
                class="historial-item"
                (click)="buscarDirecto(termino)">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ termino }}</span>
                <button 
                  class="btn-eliminar-historial"
                  (click)="eliminarDelHistorial(termino); $event.stopPropagation()">
                  <ion-icon name="close-outline"></ion-icon>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Filtros avanzados para ejercicios -->
          <div *ngIf="tipoBusqueda === 'ejercicios'" class="filtros-avanzados">
            <div class="filtro-item">
              <label>Grupo muscular:</label>
              <select [(ngModel)]="filtroGrupoMuscular" (change)="buscar()" class="filtro-select">
                <option value="">Todos</option>
                <option value="Piernas">Piernas</option>
                <option value="Pecho">Pecho</option>
                <option value="Espalda">Espalda</option>
                <option value="Brazos">Brazos</option>
                <option value="Core">Core</option>
                <option value="Cuerpo completo">Cuerpo completo</option>
              </select>
            </div>
            <div class="filtro-item">
              <label>Duración máx (min):</label>
              <input type="number" [(ngModel)]="filtroDuracion" (change)="buscar()" class="filtro-input" placeholder="Sin límite">
            </div>
            <div class="filtro-item">
              <label>Ordenar por:</label>
              <select [(ngModel)]="ordenarPor" (change)="buscar()" class="filtro-select">
                <option value="relevancia">Relevancia</option>
                <option value="nombre">Nombre</option>
                <option value="duracion">Duración</option>
              </select>
            </div>
          </div>

          <!-- Loading -->
          <div *ngIf="cargando" class="loading-container">
            <ion-spinner></ion-spinner>
            <p>Buscando...</p>
          </div>

          <!-- Resultados Usuarios -->
          <div *ngIf="!cargando && mostrarResultados && tipoBusqueda === 'usuarios'">
            <div *ngIf="usuariosEncontrados.length === 0" class="sin-resultados">
              <p>No se encontraron usuarios</p>
            </div>
            
            <ion-list *ngIf="usuariosEncontrados.length > 0">
              <ion-item *ngFor="let usuario of usuariosEncontrados" class="resultado-item">
                <ion-avatar slot="start">
                  <img [src]="usuario.avatar || 'assets/icon/SouFitLogo.png'" [alt]="usuario.username">
                </ion-avatar>
                <ion-label>
                  <h2>{{ usuario.nombre }}</h2>
                  <p>@{{ usuario.username }}</p>
                </ion-label>
                <ion-button 
                  slot="end" 
                  fill="outline" 
                  size="small"
                  (click)="usuario.siguiendo ? dejarDeSeguir(usuario) : seguirUsuario(usuario)">
                  {{ usuario.siguiendo ? 'Siguiendo' : 'Seguir' }}
                </ion-button>
              </ion-item>
            </ion-list>
          </div>

          <!-- Resultados Ejercicios -->
          <div *ngIf="!cargando && mostrarResultados && tipoBusqueda === 'ejercicios'">
            <div *ngIf="ejerciciosEncontrados.length === 0" class="sin-resultados">
              <p>No se encontraron ejercicios</p>
            </div>
            
            <div *ngIf="ejerciciosEncontrados.length > 0" class="ejercicios-grid">
              <div *ngFor="let ejercicio of ejerciciosEncontrados" class="ejercicio-card">
                <div class="ejercicio-header" (click)="verEjercicio(ejercicio.id_ejercicio!)">
                  <ion-icon name="barbell-outline"></ion-icon>
                  <h3>{{ ejercicio.nombre_ejercicio }}</h3>
                </div>
                <p class="ejercicio-descripcion" (click)="verEjercicio(ejercicio.id_ejercicio!)">{{ ejercicio.descripcion || 'Sin descripción' }}</p>
                <div class="ejercicio-tags" (click)="verEjercicio(ejercicio.id_ejercicio!)">
                  <ion-chip *ngIf="ejercicio.tipo" color="primary" size="small">
                    <ion-label>{{ ejercicio.tipo }}</ion-label>
                  </ion-chip>
                  <ion-chip *ngIf="ejercicio.grupo_muscular" color="secondary" size="small">
                    <ion-label>{{ ejercicio.grupo_muscular }}</ion-label>
                  </ion-chip>
                  <ion-chip *ngIf="ejercicio.dificultad" color="tertiary" size="small">
                    <ion-label>{{ ejercicio.dificultad }}</ion-label>
                  </ion-chip>
                </div>
                <div class="ejercicio-stats" (click)="verEjercicio(ejercicio.id_ejercicio!)">
                  <span *ngIf="ejercicio.duracion_minutos">⏱️ {{ ejercicio.duracion_minutos }} min</span>
                  <span *ngIf="ejercicio.total_likes">❤️ {{ ejercicio.total_likes }}</span>
                </div>
                <div class="ejercicio-actions">
                  <ion-button fill="outline" size="small" (click)="agregarARutina(ejercicio); $event.stopPropagation()">
                    <ion-icon name="add-outline" slot="start"></ion-icon>
                    Agregar a Rutina
                  </ion-button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Modal Agregar a Rutina -->
  <ion-modal [isOpen]="mostrarModalAgregarRutina" (didDismiss)="cerrarModalAgregarRutina()">
    <ion-header>
      <ion-toolbar>
        <ion-title>Agregar a Rutina</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalAgregarRutina()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <div *ngIf="ejercicioSeleccionado">
          <h3>{{ ejercicioSeleccionado.nombre_ejercicio }}</h3>
          <p>{{ ejercicioSeleccionado.descripcion || 'Sin descripción' }}</p>
        </div>

        <div class="ion-margin-top">
          <h4>Selecciona una rutina:</h4>
          <ion-list>
            <ion-item 
              *ngFor="let rutina of rutinasUsuario" 
              button 
              (click)="seleccionarRutina(rutina)"
              [class.selected]="rutinaSeleccionada?.id_rutina === rutina.id_rutina">
              <ion-label>
                <h2>{{ rutina.nombre_rutina }}</h2>
                <p *ngIf="rutina.descripcion">{{ rutina.descripcion }}</p>
                <p *ngIf="rutina.dias && rutina.dias.length > 0">
                  {{ rutina.dias.length }} día(s) configurado(s)
                </p>
              </ion-label>
              <ion-icon *ngIf="rutinaSeleccionada?.id_rutina === rutina.id_rutina" name="checkmark-outline" slot="end"></ion-icon>
            </ion-item>
          </ion-list>
        </div>

        <div *ngIf="rutinaSeleccionada && rutinaSeleccionada.dias && rutinaSeleccionada.dias.length > 0" class="ion-margin-top">
          <h4>Selecciona un día:</h4>
          <ion-list>
            <ion-item 
              *ngFor="let dia of rutinaSeleccionada.dias" 
              button 
              (click)="diaSeleccionado = dia"
              [class.selected]="diaSeleccionado?.id_dia === dia.id_dia">
              <ion-label>
                <h2>{{ dia.nombre_dia || 'Día ' + dia.numero_dia }}</h2>
                <p *ngIf="dia.descripcion">{{ dia.descripcion }}</p>
                <p *ngIf="dia.ejercicios">{{ dia.ejercicios.length }} ejercicio(s)</p>
              </ion-label>
              <ion-icon *ngIf="diaSeleccionado?.id_dia === dia.id_dia" name="checkmark-outline" slot="end"></ion-icon>
            </ion-item>
          </ion-list>
        </div>

        <div *ngIf="rutinaSeleccionada && (!rutinaSeleccionada.dias || rutinaSeleccionada.dias.length === 0)" class="ion-margin-top">
          <ion-text color="warning">
            <p>Esta rutina no tiene días configurados. Por favor, edita la rutina primero.</p>
          </ion-text>
        </div>

        <!-- Configuración del ejercicio -->
        <div *ngIf="rutinaSeleccionada && rutinaSeleccionada.dias && rutinaSeleccionada.dias.length > 0 && diaSeleccionado" class="ion-margin-top">
          <h4>Configuración del ejercicio:</h4>
          
          <ion-item>
            <ion-label position="stacked">Series</ion-label>
            <ion-input 
              type="number" 
              [(ngModel)]="ejercicioConfig.series" 
              min="1" 
              placeholder="3">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Repeticiones</ion-label>
            <ion-input 
              type="text" 
              [(ngModel)]="ejercicioConfig.repeticiones" 
              placeholder="10-12">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Peso recomendado (kg)</ion-label>
            <ion-input 
              type="number" 
              [(ngModel)]="ejercicioConfig.peso_recomendado" 
              min="0" 
              placeholder="0 (opcional)">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Descanso (segundos)</ion-label>
            <ion-input 
              type="number" 
              [(ngModel)]="ejercicioConfig.descanso_segundos" 
              min="0" 
              placeholder="60">
            </ion-input>
          </ion-item>
        </div>

        <div class="ion-margin-top">
          <ion-button 
            expand="block" 
            (click)="confirmarAgregarEjercicio()"
            [disabled]="!rutinaSeleccionada || (rutinaSeleccionada.dias && rutinaSeleccionada.dias.length > 0 && !diaSeleccionado) || !ejercicioConfig.series || !ejercicioConfig.repeticiones">
            Agregar Ejercicio
          </ion-button>
        </div>
    </ion-content>
  </ion-modal>

