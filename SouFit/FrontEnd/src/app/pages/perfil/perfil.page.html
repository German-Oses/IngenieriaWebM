<ion-content class="ion-no-padding">
  
  <!-- Header m칩vil -->
  <div class="header-movil">
    <button class="btn-menu-hamburguesa" (click)="volverHome()">
      <ion-icon name="arrow-back-outline"></ion-icon>
    </button>
    <h1>Perfil</h1>
  </div>
  
  <ion-grid style="height: 100vh;">
    <ion-row style="height: 100%;">
        
        <!-- 游릱 MEN칔 LATERAL -->
        <ion-col size="auto" class="menu-lateral">

          <div class="logo">
            <img src="assets/icon/SouFitLogo.png" alt="Logo">
          </div>

          <div class="boton-menu" (click)="volverHome()">
            <ion-icon name="home-outline"></ion-icon>
            <p>Inicio</p>
          </div>

          <div class="boton-menu" (click)="buscar()">
            <ion-icon name="search-outline"></ion-icon>
            <p>Buscar</p>
          </div>

          <div class="boton-menu" (click)="rutinas()">
            <ion-icon name="barbell-outline"></ion-icon>
            <p>Rutinas</p>
          </div>
                        
          <div class="boton-menu" (click)="mensajeria()">
            <ion-icon name="chatbubbles-outline"></ion-icon>
            <p>Mensajeria</p>
          </div>

          <div class="boton-menu activo">
            <ion-icon name="person-outline"></ion-icon>
            <p>Perfil</p>
          </div>

        </ion-col>

        <!-- 游릴 CONTENIDO CENTRAL -->
        <ion-col class="feed-centro">

          <!-- Header del perfil -->
          <div class="titulo-feed" *ngIf="userProfile">
            <h1>{{ userProfile.nombre || userProfile.username }}</h1>

            <div class="botones-header">

              <button class="btn-crear-post" (click)="toggleEdicion()" *ngIf="!editando">
                <ion-icon name="create-outline"></ion-icon>
                Editar perfil
              </button>

              <button class="btn-crear-post btn-cancelar" (click)="cancelarEdicion()" *ngIf="editando">
                Cancelar
              </button>

              <button class="btn-crear-post btn-logout" (click)="confirmarCerrarSesion()" *ngIf="!editando">
                <ion-icon name="log-out-outline"></ion-icon>
                Cerrar sesi칩n
              </button>

            </div>
          </div>

          <div class="posts-contenedor" *ngIf="userProfile">
            <div class="posts-contenedor-inner">

              <!-- 游릳 HEADER PERFIL (vista normal) -->
              <div class="post perfil-header" *ngIf="!editando">
                <div class="perfil-contenido">

                  <ion-avatar class="perfil-avatar">
                    <img [src]="obtenerUrlArchivo(userProfile?.avatar) || 'assets/icon/SouFitLogo.png'" alt="Avatar" (error)="$event.target.src='assets/icon/SouFitLogo.png'">
                  </ion-avatar>

                  <div class="perfil-info">

                    <div class="perfil-nombre-header">
                      <h2 class="perfil-nombre">{{ userProfile.nombre || userProfile.username }}</h2>

                      <button class="btn-crear-post btn-editar-inline" (click)="toggleEdicion()">
                        <ion-icon name="create-outline"></ion-icon>
                        Editar perfil
                      </button>
                    </div>

                    <div class="perfil-stats">
                      <div class="stat-item">
                        <strong>{{ totalPosts || 0 }}</strong>
                        <span>publicaciones</span>
                      </div>

                      <div class="stat-item">
                        <strong>{{ totalSeguidores || 0 }}</strong>
                        <span>seguidores</span>
                      </div>

                      <div class="stat-item">
                        <strong>{{ totalSiguiendo || 0 }}</strong>
                        <span>siguiendo</span>
                      </div>
                    </div>

                    <div class="perfil-acciones">
                      <button class="btn-estadisticas" (click)="toggleEstadisticas()">
                        <ion-icon name="stats-chart-outline"></ion-icon>
                        {{ mostrarEstadisticas ? 'Ocultar' : 'Ver' }} Estad칤sticas
                      </button>
                    </div>

                    <div class="perfil-descripcion">
                      <h3 class="perfil-nombre-completo">{{ userProfile.nombre || userProfile.username }}</h3>

                      <p class="bio-text" *ngIf="userProfile.bio">{{ userProfile.bio }}</p>

                      <p class="ubicacion-text" *ngIf="userProfile.nombre_region">
                        <ion-icon name="location-outline"></ion-icon>
                        {{ userProfile.nombre_region }}{{ userProfile.nombre_comuna ? ', ' + userProfile.nombre_comuna : '' }}
                      </p>
                    </div>

                  </div>
                </div>
              </div>

              <!-- 游릲 FORMULARIO EDICI칍N -->
              <div class="post editar-post" *ngIf="editando">

                <div class="post-header">
                  <h2>Editar Perfil</h2>
                </div>

                <div class="post-contenido">

                  <!-- Avatar con bot칩n de cambiar -->
                  <div class="perfil-avatar-editar">
                    <ion-avatar class="perfil-avatar">
                      <img [src]="obtenerUrlArchivo(perfilEditado.avatar || userProfile?.avatar) || 'assets/icon/SouFitLogo.png'" alt="Avatar" (error)="$event.target.src='assets/icon/SouFitLogo.png'">
                    </ion-avatar>
                    <button class="btn-cambiar-avatar" (click)="cambiarAvatar()">
                      <ion-icon name="camera-outline"></ion-icon>
                      Cambiar foto
                    </button>
                  </div>

                  <ion-input [(ngModel)]="perfilEditado.nombre" placeholder="Nombre" class="input-editar"></ion-input>

                  <ion-input [(ngModel)]="perfilEditado.apellido" placeholder="Apellido" class="input-editar"></ion-input>

                  <ion-input [(ngModel)]="perfilEditado.username" placeholder="Username" class="input-editar"></ion-input>

                  <ion-textarea [(ngModel)]="perfilEditado.bio" placeholder="Biograf칤a" rows="3" class="input-editar textarea-editar"></ion-textarea>

                  <ion-input type="date" [(ngModel)]="perfilEditado.fecha_nacimiento" placeholder="Fecha de nacimiento" class="input-editar"></ion-input>

                  <ion-item style="border-radius: 10px; border: 1px solid #E0E0E0; margin-bottom: 16px;">
                    <ion-select label="Regi칩n" label-placement="floating" [(ngModel)]="perfilEditado.id_region" (ionChange)="onRegionChange()" [disabled]="cargandoRegiones">
                      <ion-select-option *ngIf="cargandoRegiones" disabled>Cargando regiones...</ion-select-option>
                      <ion-select-option *ngIf="!cargandoRegiones && regiones.length === 0" disabled>No hay regiones disponibles</ion-select-option>
                      <ion-select-option *ngFor="let region of regiones" [value]="region.id_region">
                        {{ region.nombre_region }}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>

                  <ion-item style="border-radius: 10px; border: 1px solid #E0E0E0; margin-bottom: 16px;">
                    <ion-select label="Comuna" label-placement="floating" [(ngModel)]="perfilEditado.id_comuna" [disabled]="!perfilEditado.id_region">
                      <ion-select-option *ngIf="!perfilEditado.id_region" disabled>Selecciona una regi칩n primero</ion-select-option>
                      <ion-select-option *ngFor="let comuna of comunas" [value]="comuna.id_comuna">
                        {{ comuna.nombre_comuna }}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>

                  <ion-button expand="block" (click)="guardarPerfil()" class="btn-guardar">Guardar Cambios</ion-button>

                </div>

              </div>

              <!-- 游릱 ESTAD칈STICAS AVANZADAS -->
              <div class="post estadisticas-card" *ngIf="!editando && mostrarEstadisticas">
                <div class="post-header">
                  <h2>
                    <ion-icon name="stats-chart-outline"></ion-icon>
                    Estad칤sticas Detalladas
                  </h2>
                </div>
                <div class="post-contenido">
                  <div *ngIf="cargandoEstadisticas" class="cargando-estadisticas">
                    <p>Cargando estad칤sticas...</p>
                  </div>
                  
                  <div *ngIf="!cargandoEstadisticas && estadisticas" class="estadisticas-grid">
                    <div class="stat-card">
                      <ion-icon name="document-text-outline"></ion-icon>
                      <div class="stat-info">
                        <strong>{{ estadisticas.total_posts || 0 }}</strong>
                        <span>Posts</span>
                      </div>
                    </div>
                    <div class="stat-card">
                      <ion-icon name="barbell-outline"></ion-icon>
                      <div class="stat-info">
                        <strong>{{ estadisticas.total_rutinas || 0 }}</strong>
                        <span>Rutinas</span>
                      </div>
                    </div>
                    <div class="stat-card">
                      <ion-icon name="heart-outline"></ion-icon>
                      <div class="stat-info">
                        <strong>{{ estadisticas.total_likes_posts || 0 }}</strong>
                        <span>Likes</span>
                      </div>
                    </div>
                    <div class="stat-card">
                      <ion-icon name="chatbubble-outline"></ion-icon>
                      <div class="stat-info">
                        <strong>{{ estadisticas.total_comentarios_posts || 0 }}</strong>
                        <span>Comentarios</span>
                      </div>
                    </div>
                    <div class="stat-card">
                      <ion-icon name="people-outline"></ion-icon>
                      <div class="stat-info">
                        <strong>{{ estadisticas.total_seguidores || 0 }}</strong>
                        <span>Seguidores</span>
                      </div>
                    </div>
                    <div class="stat-card">
                      <ion-icon name="bookmark-outline"></ion-icon>
                      <div class="stat-info">
                        <strong>{{ estadisticas.total_rutinas_guardadas || 0 }}</strong>
                        <span>Rutinas Guardadas</span>
                      </div>
                    </div>
                  </div>

                  <!-- Logros -->
                  <div class="logros-section" *ngIf="logros.length > 0">
                    <h3>
                      <ion-icon name="trophy-outline"></ion-icon>
                      Logros Obtenidos ({{ logros.length }})
                    </h3>
                    <div class="logros-grid">
                      <div class="logro-item" *ngFor="let logro of logros">
                        <ion-icon [name]="logro.icono || 'trophy-outline'"></ion-icon>
                        <div class="logro-info">
                          <strong>{{ logro.nombre_logro }}</strong>
                          <span>{{ logro.descripcion }}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Historial Reciente -->
                  <div class="historial-section" *ngIf="historialReciente.length > 0">
                    <h3>
                      <ion-icon name="calendar-outline"></ion-icon>
                      Entrenamientos Recientes
                    </h3>
                    <div class="historial-list">
                      <div class="historial-item" *ngFor="let entrenamiento of historialReciente">
                        <div class="historial-fecha">
                          {{ entrenamiento.fecha_entrenamiento | date:'dd/MM/yyyy' }}
                        </div>
                        <div class="historial-info">
                          <strong>{{ entrenamiento.nombre_rutina || entrenamiento.nombre_ejercicio || 'Entrenamiento' }}</strong>
                          <span *ngIf="entrenamiento.duracion_minutos">{{ entrenamiento.duracion_minutos }} min</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Progreso F칤sico -->
                  <div class="progreso-section" *ngIf="progresoFisico">
                    <h3>
                      <ion-icon name="trending-up-outline"></ion-icon>
                      Progreso F칤sico (칔ltimos 90 d칤as)
                    </h3>
                    <div class="progreso-stats">
                      <div class="progreso-item" *ngIf="progresoFisico.peso_actual">
                        <strong>Peso Actual:</strong>
                        <span>{{ progresoFisico.peso_actual }} kg</span>
                      </div>
                      <div class="progreso-item" *ngIf="progresoFisico.peso_inicial">
                        <strong>Peso Inicial:</strong>
                        <span>{{ progresoFisico.peso_inicial }} kg</span>
                      </div>
                      <div class="progreso-item" *ngIf="progresoFisico.peso_actual && progresoFisico.peso_inicial">
                        <strong>Diferencia:</strong>
                        <span [class.positivo]="(progresoFisico.peso_actual - progresoFisico.peso_inicial) < 0"
                              [class.negativo]="(progresoFisico.peso_actual - progresoFisico.peso_inicial) > 0">
                          {{ (progresoFisico.peso_actual - progresoFisico.peso_inicial) > 0 ? '+' : '' }}{{ (progresoFisico.peso_actual - progresoFisico.peso_inicial).toFixed(1) }} kg
                        </span>
                      </div>
                      <div class="progreso-item">
                        <strong>Total Registros:</strong>
                        <span>{{ progresoFisico.total_registros }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 游린 GRID DE PUBLICACIONES -->
              <div class="posts-grid" *ngIf="!editando">

                <div *ngIf="posts.length === 0" class="sin-posts-grid">
                  <ion-icon name="images-outline"></ion-icon>
                  <p>No hay publicaciones a칰n</p>
                </div>

                <div class="post-grid-item" *ngFor="let post of posts" (click)="verPost(post)">

                  <img *ngIf="post.url_media" [src]="post.url_media" class="post-grid-image">

                  <div *ngIf="!post.url_media" class="post-grid-text">
                    <ion-icon name="document-text-outline"></ion-icon>
                    <p>{{ post.contenido?.substring(0, 50) || 'Sin contenido' }}...</p>
                  </div>

                  <div class="post-overlay-hover">
                    <span><ion-icon name="heart-outline"></ion-icon> {{ post.total_likes || 0 }}</span>
                    <span><ion-icon name="chatbubble-outline"></ion-icon> {{ post.total_comentarios || 0 }}</span>
                  </div>
                </div>

              </div>

            </div>
          </div>

        </ion-col>

    </ion-row>
  </ion-grid>
</ion-content>

