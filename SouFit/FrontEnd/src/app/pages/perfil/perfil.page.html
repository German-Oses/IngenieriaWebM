<ion-content class="ion-no-padding">
  
  <!-- Header móvil -->
  <div class="header-movil">
    <button class="btn-menu-hamburguesa" (click)="volverHome()">
      <ion-icon name="arrow-back-outline"></ion-icon>
    </button>
    <h1>Mi Perfil</h1>
    <button class="btn-editar-movil" (click)="toggleEdicion()" *ngIf="!editando && userProfile">
      <ion-icon name="create-outline"></ion-icon>
    </button>
  </div>
  
  <div class="perfil-container" *ngIf="userProfile && !cargando">
    
    <!-- Header del perfil -->
    <div class="perfil-header-section">
      <div class="perfil-cover">
        <div class="perfil-avatar-wrapper">
          <ion-avatar class="perfil-avatar-large">
            <img [src]="obtenerUrlArchivo(userProfile?.avatar)" alt="Avatar" (error)="handleImageError($event)">
            <div class="avatar-overlay" *ngIf="editando" (click)="cambiarAvatar()">
              <ion-icon name="camera-outline"></ion-icon>
            </div>
            <ion-spinner *ngIf="subiendoAvatar" class="avatar-spinner"></ion-spinner>
          </ion-avatar>
        </div>
      </div>
      
      <div class="perfil-info-header">
        <div class="perfil-nombre-section">
          <h1 class="perfil-nombre-principal">{{ userProfile.nombre || userProfile.username }}</h1>
          <p class="perfil-username">@{{ userProfile.username }}</p>
        </div>
        
        <div class="perfil-acciones-header">
          <button class="btn-editar-perfil" (click)="toggleEdicion()" *ngIf="!editando">
            <ion-icon name="create-outline"></ion-icon>
            <span>Editar</span>
          </button>
          <button class="btn-cerrar-sesion" (click)="confirmarCerrarSesion()" *ngIf="!editando">
            <ion-icon name="log-out-outline"></ion-icon>
          </button>
        </div>
      </div>
      
      <div class="perfil-stats-section">
        <div class="stat-box">
          <strong class="stat-number">{{ totalPosts || 0 }}</strong>
          <span class="stat-label">Publicaciones</span>
        </div>
        <div class="stat-box">
          <strong class="stat-number">{{ totalSeguidores || 0 }}</strong>
          <span class="stat-label">Seguidores</span>
        </div>
        <div class="stat-box">
          <strong class="stat-number">{{ totalSiguiendo || 0 }}</strong>
          <span class="stat-label">Siguiendo</span>
        </div>
      </div>
      
      <div class="perfil-bio-section" *ngIf="!editando">
        <p class="perfil-bio" *ngIf="userProfile.bio">{{ userProfile.bio }}</p>
        <div class="perfil-ubicacion" *ngIf="userProfile.nombre_region">
          <ion-icon name="location-outline"></ion-icon>
          <span>{{ userProfile.nombre_region }}{{ userProfile.nombre_comuna ? ', ' + userProfile.nombre_comuna : '' }}</span>
        </div>
      </div>
    </div>

    <!-- Formulario de edición -->
    <div class="editar-perfil-section" *ngIf="editando">
      <div class="editar-card">
        <div class="editar-header">
          <h2>Editar Perfil</h2>
          <button class="btn-cerrar-edicion" (click)="cancelarEdicion()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        
        <div class="editar-body">
          <div class="avatar-editar-wrapper">
            <ion-avatar class="avatar-editar">
              <img [src]="obtenerUrlArchivo(perfilEditado.avatar || userProfile?.avatar)" alt="Avatar" (error)="handleImageError($event)">
            </ion-avatar>
            <button class="btn-cambiar-avatar" (click)="cambiarAvatar()">
              <ion-icon name="camera-outline"></ion-icon>
              Cambiar foto
            </button>
          </div>
          
          <div class="form-group">
            <label>Nombre</label>
            <ion-input [(ngModel)]="perfilEditado.nombre" placeholder="Nombre" class="input-moderno"></ion-input>
          </div>
          
          <div class="form-group">
            <label>Apellido</label>
            <ion-input [(ngModel)]="perfilEditado.apellido" placeholder="Apellido" class="input-moderno"></ion-input>
          </div>
          
          <div class="form-group">
            <label>Username</label>
            <ion-input [(ngModel)]="perfilEditado.username" placeholder="Username" class="input-moderno"></ion-input>
          </div>
          
          <div class="form-group">
            <label>Biografía</label>
            <ion-textarea [(ngModel)]="perfilEditado.bio" placeholder="Cuéntanos sobre ti..." rows="4" class="textarea-moderno"></ion-textarea>
          </div>
          
          <div class="form-group">
            <label>Fecha de nacimiento</label>
            <ion-input type="date" [(ngModel)]="perfilEditado.fecha_nacimiento" class="input-moderno"></ion-input>
          </div>
          
          <div class="form-group">
            <label>Región</label>
            <ion-item class="select-moderno">
              <ion-select [(ngModel)]="perfilEditado.id_region" (ionChange)="onRegionChange()" [disabled]="cargandoRegiones" placeholder="Selecciona una región">
                <ion-select-option *ngFor="let region of regiones" [value]="region.id_region">
                  {{ region.nombre_region }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </div>
          
          <div class="form-group">
            <label>Comuna</label>
            <ion-item class="select-moderno">
              <ion-select [(ngModel)]="perfilEditado.id_comuna" [disabled]="!perfilEditado.id_region" placeholder="Selecciona una comuna">
                <ion-select-option *ngIf="!perfilEditado.id_region" disabled>Selecciona una región primero</ion-select-option>
                <ion-select-option *ngFor="let comuna of comunas" [value]="comuna.id_comuna">
                  {{ comuna.nombre_comuna }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </div>
          
          <div class="editar-acciones">
            <ion-button 
              expand="block" 
              (click)="guardarPerfil()" 
              [disabled]="guardandoPerfil"
              class="btn-guardar-moderno">
              <ion-spinner *ngIf="guardandoPerfil" name="crescent" slot="start"></ion-spinner>
              <ion-icon *ngIf="!guardandoPerfil" name="checkmark-outline" slot="start"></ion-icon>
              {{ guardandoPerfil ? 'Guardando...' : 'Guardar Cambios' }}
            </ion-button>
            <ion-button 
              expand="block" 
              fill="outline" 
              (click)="cancelarEdicion()" 
              [disabled]="guardandoPerfil"
              class="btn-cancelar-moderno">
              Cancelar
            </ion-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Estadísticas avanzadas -->
    <div class="estadisticas-section" *ngIf="!editando">
      <button class="btn-toggle-estadisticas" (click)="toggleEstadisticas()">
        <ion-icon name="stats-chart-outline"></ion-icon>
        <span>{{ mostrarEstadisticas ? 'Ocultar' : 'Ver' }} Estadísticas</span>
        <ion-icon [name]="mostrarEstadisticas ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
      </button>
      
      <div class="estadisticas-content" *ngIf="mostrarEstadisticas">
        <div *ngIf="cargandoEstadisticas" class="cargando-estadisticas">
          <ion-spinner></ion-spinner>
          <p>Cargando estadísticas...</p>
        </div>
        
        <div *ngIf="!cargandoEstadisticas && estadisticas" class="estadisticas-grid">
          <div class="stat-card-moderno">
            <ion-icon name="document-text-outline"></ion-icon>
            <div class="stat-info-moderno">
              <strong>{{ estadisticas.total_posts || 0 }}</strong>
              <span>Posts</span>
            </div>
          </div>
          <div class="stat-card-moderno">
            <ion-icon name="barbell-outline"></ion-icon>
            <div class="stat-info-moderno">
              <strong>{{ estadisticas.total_rutinas || 0 }}</strong>
              <span>Rutinas</span>
            </div>
          </div>
          <div class="stat-card-moderno">
            <ion-icon name="heart-outline"></ion-icon>
            <div class="stat-info-moderno">
              <strong>{{ estadisticas.total_likes_posts || 0 }}</strong>
              <span>Likes</span>
            </div>
          </div>
          <div class="stat-card-moderno">
            <ion-icon name="chatbubble-outline"></ion-icon>
            <div class="stat-info-moderno">
              <strong>{{ estadisticas.total_comentarios_posts || 0 }}</strong>
              <span>Comentarios</span>
            </div>
          </div>
        </div>
        
        <div class="logros-section-moderno" *ngIf="logros.length > 0">
          <h3>
            <ion-icon name="trophy-outline"></ion-icon>
            Logros ({{ logros.length }})
          </h3>
          <div class="logros-grid-moderno">
            <div class="logro-card" *ngFor="let logro of logros">
              <ion-icon [name]="logro.icono || 'trophy-outline'"></ion-icon>
              <div class="logro-info-moderno">
                <strong>{{ logro.nombre_logro }}</strong>
                <span>{{ logro.descripcion }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grid de publicaciones -->
    <div class="posts-section" *ngIf="!editando">
      <div class="posts-section-header">
        <h2>Publicaciones</h2>
      </div>
      
      <div class="posts-grid-moderno" *ngIf="posts.length > 0">
        <div class="post-item-moderno" *ngFor="let post of posts" (click)="verPost(post)">
          <div class="post-image-wrapper" *ngIf="post.url_media">
            <img [src]="obtenerUrlArchivo(post.url_media)" alt="Post" (error)="handleImageError($event)">
            <div class="post-overlay">
              <div class="post-stats-overlay">
                <span><ion-icon name="heart-outline"></ion-icon> {{ post.total_likes || 0 }}</span>
                <span><ion-icon name="chatbubble-outline"></ion-icon> {{ post.total_comentarios || 0 }}</span>
              </div>
            </div>
          </div>
          <div class="post-text-wrapper" *ngIf="!post.url_media">
            <ion-icon name="document-text-outline"></ion-icon>
            <p>{{ post.contenido?.substring(0, 100) || 'Sin contenido' }}...</p>
          </div>
        </div>
      </div>
      
      <div class="sin-posts-moderno" *ngIf="posts.length === 0">
        <ion-icon name="images-outline"></ion-icon>
        <h3>No hay publicaciones aún</h3>
        <p>Comienza a compartir tus entrenamientos y logros</p>
      </div>
    </div>
  </div>
  
  <!-- Loading state -->
  <div class="loading-container" *ngIf="cargando">
    <ion-spinner></ion-spinner>
    <p>Cargando perfil...</p>
  </div>

  <!-- Menú lateral desktop -->
  <div class="menu-lateral-desktop">
    <div class="logo-desktop">
      <img src="assets/icon/SouFitLogo.png" alt="Logo">
    </div>
    <div class="boton-menu-desktop" (click)="volverHome()">
      <ion-icon name="home-outline"></ion-icon>
      <span>Inicio</span>
    </div>
    <div class="boton-menu-desktop" (click)="buscar()">
      <ion-icon name="search-outline"></ion-icon>
      <span>Buscar</span>
    </div>
    <div class="boton-menu-desktop" (click)="rutinas()">
      <ion-icon name="barbell-outline"></ion-icon>
      <span>Rutinas</span>
    </div>
    <div class="boton-menu-desktop" (click)="mensajeria()">
      <ion-icon name="chatbubbles-outline"></ion-icon>
      <span>Mensajes</span>
    </div>
    <div class="boton-menu-desktop activo">
      <ion-icon name="person-outline"></ion-icon>
      <span>Perfil</span>
    </div>
  </div>
</ion-content>
