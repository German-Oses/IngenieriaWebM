<ion-content class="ion-no-padding">
  
  <!-- Header m贸vil -->
  <div class="header-movil">
    <button class="btn-menu-hamburguesa" (click)="volverHome()">
      <ion-icon name="arrow-back-outline"></ion-icon>
    </button>
    <h1>Perfil</h1>
  </div>
  
  <ion-grid style="height: 100vh;">
    <ion-row style="height: 100%;">
        
        <!--  MEN LATERAL -->
        <ion-col size="auto" class="menu-lateral">

          <div class="logo">
            <img src="assets/icon/SouFitLogo.png" alt="Logo">
          </div>

          <div class="boton-menu" (click)="volverHome()">
            <ion-icon name="home-outline"></ion-icon>
            <p>Inicio</p>
          </div>

          <div class="boton-menu" (click)="buscar()">
            <ion-icon name="search-outline"></ion-icon>
            <p>Buscar</p>
          </div>

          <div class="boton-menu" (click)="rutinas()">
            <ion-icon name="barbell-outline"></ion-icon>
            <p>Rutinas</p>
          </div>
                        
          <div class="boton-menu" (click)="mensajeria()">
            <ion-icon name="chatbubbles-outline"></ion-icon>
            <p>Mensajeria</p>
          </div>

          <div class="boton-menu activo">
            <ion-icon name="person-outline"></ion-icon>
            <p>Perfil</p>
          </div>

        </ion-col>

        <!--  CONTENIDO CENTRAL -->
        <ion-col class="feed-centro">

          <!-- Header del perfil -->
          <div class="titulo-feed" *ngIf="userProfile">
            <h1>{{ userProfile.nombre || userProfile.username }}</h1>

            <div class="botones-header">

              <button class="btn-crear-post" (click)="toggleEdicion()" *ngIf="!editando">
                <ion-icon name="create-outline"></ion-icon>
                Editar perfil
              </button>

              <button class="btn-crear-post btn-cancelar" (click)="cancelarEdicion()" *ngIf="editando">
                Cancelar
              </button>

              <button class="btn-crear-post btn-logout" (click)="confirmarCerrarSesion()" *ngIf="!editando">
                <ion-icon name="log-out-outline"></ion-icon>
                Cerrar sesi贸n
              </button>

            </div>
          </div>

          <div class="posts-contenedor" *ngIf="userProfile">
            <div class="posts-contenedor-inner">

              <!--  HEADER PERFIL (vista normal) -->
              <div class="post perfil-header" *ngIf="!editando">
                <div class="perfil-contenido">

                  <ion-avatar class="perfil-avatar" *ngIf="!editando">
                    <img [src]="obtenerUrlArchivo(userProfile?.avatar) || 'assets/icon/SouFitLogo.png'" alt="Avatar" (error)="$event.target.src='assets/icon/SouFitLogo.png'">
                  </ion-avatar>
                  
                  <div class="perfil-avatar-editar" *ngIf="editando">
                    <ion-avatar class="perfil-avatar">
                      <img [src]="obtenerUrlArchivo(perfilEditado.avatar || userProfile?.avatar) || 'assets/icon/SouFitLogo.png'" alt="Avatar" (error)="$event.target.src='assets/icon/SouFitLogo.png'">
                    </ion-avatar>
                    <button class="btn-cambiar-avatar" (click)="cambiarAvatar()">
                      <ion-icon name="camera-outline"></ion-icon>
                      Cambiar foto
                    </button>
                  </div>

                  <div class="perfil-info">

                    <div class="perfil-nombre-header">
                      <h2 class="perfil-nombre">{{ userProfile.nombre || userProfile.username }}</h2>

                      <button class="btn-crear-post btn-editar-inline" (click)="toggleEdicion()">
                        <ion-icon name="create-outline"></ion-icon>
                        Editar perfil
                      </button>
                    </div>

                    <div class="perfil-stats">
                      <div class="stat-item">
                        <strong>{{ totalPosts || 0 }}</strong>
                        <span>publicaciones</span>
                      </div>

                      <div class="stat-item">
                        <strong>{{ totalSeguidores || 0 }}</strong>
                        <span>seguidores</span>
                      </div>

                      <div class="stat-item">
                        <strong>{{ totalSiguiendo || 0 }}</strong>
                        <span>siguiendo</span>
                      </div>
                    </div>

                    <div class="perfil-descripcion">
                      <h3 class="perfil-nombre-completo">{{ userProfile.nombre || userProfile.username }}</h3>

                      <p class="bio-text" *ngIf="userProfile.bio">{{ userProfile.bio }}</p>

                      <p class="ubicacion-text" *ngIf="userProfile.nombre_region">
                        <ion-icon name="location-outline"></ion-icon>
                        {{ userProfile.nombre_region }}{{ userProfile.nombre_comuna ? ', ' + userProfile.nombre_comuna : '' }}
                      </p>
                    </div>

                  </div>
                </div>
              </div>

              <!--  FORMULARIO EDICIN -->
              <div class="post editar-post" *ngIf="editando">

                <div class="post-header">
                  <h2>Editar Perfil</h2>
                </div>

                <div class="post-contenido">

                  <ion-input [(ngModel)]="perfilEditado.nombre" placeholder="Nombre" class="input-editar"></ion-input>

                  <ion-input [(ngModel)]="perfilEditado.apellido" placeholder="Apellido" class="input-editar"></ion-input>

                  <ion-input [(ngModel)]="perfilEditado.username" placeholder="Username" class="input-editar"></ion-input>

                  <ion-input [(ngModel)]="perfilEditado.email" type="email" placeholder="Email" class="input-editar"></ion-input>

                  <ion-textarea [(ngModel)]="perfilEditado.bio" placeholder="Biograf铆a" rows="3" class="input-editar textarea-editar"></ion-textarea>

                  <ion-input [(ngModel)]="perfilEditado.avatar" placeholder="URL de avatar (opcional)" class="input-editar"></ion-input>
                  <p style="font-size: 12px; color: #666; margin-top: -10px; margin-bottom: 16px;">
                    O usa el bot贸n "Cambiar foto" arriba para subir una imagen
                  </p>

                  <ion-input type="date" [(ngModel)]="perfilEditado.fecha_nacimiento" placeholder="Fecha de nacimiento" class="input-editar"></ion-input>

                  <ion-item style="border-radius: 10px; border: 1px solid #E0E0E0; margin-bottom: 16px;">
                    <ion-select label="Regi贸n" label-placement="floating" [(ngModel)]="perfilEditado.id_region" (ionChange)="onRegionChange()" [disabled]="cargandoRegiones">
                      <ion-select-option *ngIf="cargandoRegiones" disabled>Cargando regiones...</ion-select-option>
                      <ion-select-option *ngIf="!cargandoRegiones && regiones.length === 0" disabled>No hay regiones disponibles</ion-select-option>
                      <ion-select-option *ngFor="let region of regiones" [value]="region.id_region">
                        {{ region.nombre_region }}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>

                  <ion-item style="border-radius: 10px; border: 1px solid #E0E0E0; margin-bottom: 16px;">
                    <ion-select label="Comuna" label-placement="floating" [(ngModel)]="perfilEditado.id_comuna" [disabled]="!perfilEditado.id_region">
                      <ion-select-option *ngIf="!perfilEditado.id_region" disabled>Selecciona una regi贸n primero</ion-select-option>
                      <ion-select-option *ngFor="let comuna of comunas" [value]="comuna.id_comuna">
                        {{ comuna.nombre_comuna }}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>

                  <ion-button expand="block" (click)="guardarPerfil()" class="btn-guardar">Guardar Cambios</ion-button>

                </div>

              </div>

              <!--  GRID DE PUBLICACIONES -->
              <div class="posts-grid" *ngIf="!editando">

                <div *ngIf="posts.length === 0" class="sin-posts-grid">
                  <ion-icon name="images-outline"></ion-icon>
                  <p>No hay publicaciones a煤n</p>
                </div>

                <div class="post-grid-item" *ngFor="let post of posts" (click)="verPost(post)">

                  <img *ngIf="post.url_media" [src]="post.url_media" class="post-grid-image">

                  <div *ngIf="!post.url_media" class="post-grid-text">
                    <ion-icon name="document-text-outline"></ion-icon>
                    <p>{{ post.contenido?.substring(0, 50) || 'Sin contenido' }}...</p>
                  </div>

                  <div class="post-overlay-hover">
                    <span><ion-icon name="heart-outline"></ion-icon> {{ post.total_likes || 0 }}</span>
                    <span><ion-icon name="chatbubble-outline"></ion-icon> {{ post.total_comentarios || 0 }}</span>
                  </div>
                </div>

              </div>

            </div>
          </div>

        </ion-col>

    </ion-row>
  </ion-grid>
</ion-content>

